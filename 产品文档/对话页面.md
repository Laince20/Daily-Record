# 对话页面

## UI设计优化

根据提供的设计图和产品需求，以下是对话页面UI设计优化方案：

### 导航栏设计
- **标题居中**：将"日常复盘"标题居中展示，字体使用18px的微软雅黑，颜色使用#333333
- **左侧菜单按钮**：采用简洁的三横线图标，点击可展开侧边栏菜单
- **时间显示**：在对话区域顶部显示当前日期和时间，格式为"下午2:56"，采用14px字体，颜色#999999

### 对话气泡设计
- **AI消息气泡**：
  - 采用左对齐圆角矩形，背景色为#FFFFFF
  - 文字颜色#333333，字体大小16px
  - 气泡左侧可选择性添加AI头像
  
- **用户消息气泡**：
  - 采用右对齐圆角矩形，背景色为#A4E3FF
  - 文字颜色#333333，字体大小16px
  - 发送状态指示（已发送、已读）

### 输入区域设计
- **输入框**：
  - 圆角输入框，高度自适应
  - 占据底部工具栏大部分空间
  - 内置提示文字"请输入..."
  
- **功能按钮**：
  - 语音输入按钮：清晰的麦克风图标
  - 发送按钮：仅在输入内容后显示
  - 工具箱图标：包含表情、图片等扩展功能

### 界面交互元素
- **思考过程展示**：底部可以有"展示思考过程"的选项，开启后AI会展示分析思路
- **底部标签栏**：清晰突出"对话"选项，使用适当图标和文字标识

## 交互逻辑设计

### 1. 对话初始化流程
1. **页面加载时**：
   - 检查用户登录状态
   - 加载最近的对话历史（最近20条）
   - 如果是新对话，AI主动发起复盘引导问题

2. **对话上下文管理**：
   - 每次会话保持完整上下文
   - 当上下文过长时，保留最近的10-15条对话
   - 在云端存储完整上下文以供分析

### 2. 用户输入处理
1. **文字输入**：
   - 实时字符计数（可选显示）
   - 支持多行输入，Enter键发送（可在设置中修改）
   - 输入超过200字时提供拆分建议

2. **语音输入**：
   - 长按开始录音，松开结束
   - 上滑取消当前录音
   - 实时显示音量波形反馈
   - 最长录音时间限制（60秒）
   - 语音识别后自动发送文字内容

### 3. AI响应机制
1. **响应时机**：
   - 用户发送消息后立即显示"正在思考..."状态
   - 控制AI响应时间在1-3秒之间（体验最佳区间）
   
2. **响应策略**：
   - 根据对话阶段提供不同深度的问题
   - 首轮对话以开放性问题为主
   - 后续对话基于用户回答进行深挖
   - 当检测到用户情绪变化时，适当调整提问策略

3. **特殊交互**：
   - 用户长时间不回应时，提供引导性提示
   - 识别用户"结束对话"意图，自动生成总结

### 4. 历史记录交互
1. **加载机制**：
   - 下拉刷新加载更早的历史消息
   - 分页加载，每次20条
   
2. **查看方式**：
   - 支持按日期跳转到特定对话
   - 支持搜索历史对话内容

## 前端逻辑流程图

```
┌─────────────────────┐
│    页面初始化       │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  检查用户登录状态   │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  加载历史对话记录   │
└──────────┬──────────┘
           ↓
┌─────────────────────┐      ┌─────────────────────┐
│   是否有历史记录?   │─否──→│  AI发起引导性问题   │
└──────────┬──────────┘      └─────────────────────┘
           │ 是
           ↓
┌─────────────────────┐
│    展示对话界面     │
└──────────┬──────────┘
           ↓
┌─────────────────────────────────────────────────┐
│                用户交互循环                     │
└─────────────────────────────────────────────────┘
           ↓
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 文字输入    │     │ 语音输入    │     │ 查看历史    │
└─────┬───────┘     └─────┬───────┘     └─────┬───────┘
      │                   │                   │
      ↓                   ↓                   ↓
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│发送文字消息 │     │录音处理     │     │加载更多记录 │
└─────┬───────┘     └─────┬───────┘     └─────────────┘
      │                   │
      │                   ↓
      │             ┌─────────────┐
      │             │语音转文字   │
      │             └─────┬───────┘
      │                   │
      ↓                   ↓
┌─────────────────────────────────┐
│        发送消息至后端           │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      显示"正在思考"状态         │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│        接收AI响应并显示         │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│        等待下一次用户输入       │
└─────────────────────────────────┘
```

## 后端逻辑流程图

```
┌─────────────────────────────────┐
│        接收用户消息             │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      验证用户身份和权限         │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│        保存消息到数据库         │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      获取历史对话上下文         │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│    构建AI请求体（含系统提示）   │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│        调用扣子API              │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────┐     ┌───────────────────────────┐
│      API调用成功?           │─否──→│  返回错误响应          │
└─────────────────┬───────────┘     └───────────────────────────┘
                  │ 是
                  ↓
┌─────────────────────────────────┐
│      处理AI响应内容             │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      保存AI回复到数据库         │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      返回AI响应给前端           │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│   判断是否需要生成每日总结      │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────┐     ┌───────────────────────────┐
│   已到总结时间或结束对话?   │─是──→│  生成总结并保存到数据库   │
└─────────────────┬───────────┘     └───────────────────────────┘
                  │ 否
                  ↓
┌─────────────────────────────────┐
│      等待下一次用户请求         │
└─────────────────────────────────┘
```

## 语音识别处理流程

```
┌─────────────────────────────────┐
│      接收录音文件               │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      上传录音至云存储           │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      获取文件云存储ID           │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      调用语音识别API            │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────┐     ┌───────────────────────────┐
│      识别成功?              │─否──→│  返回识别失败信息         │
└─────────────────┬───────────┘     └───────────────────────────┘
                  │ 是
                  ↓
┌─────────────────────────────────┐
│      返回识别文本               │
└─────────────────┬───────────────┘
                  ↓
┌─────────────────────────────────┐
│      在前端自动发送文本消息     │
└─────────────────────────────────┘
```

## 数据流向图

```
┌─────────────┐                ┌─────────────────┐              ┌─────────────┐
│             │   用户消息     │                 │   请求        │             │
│   前端      │───────────────→│  云函数服务     │──────────────→│  扣子API    │
│   小程序    │               │  (后端处理)     │              │   服务      │
│             │←──────────────│                 │←─────────────│             │
└─────────────┘   AI响应       └─────────────────┘   响应        └─────────────┘
       ↑                              ↑ ↓
       │                              │ │
       │                              │ │
       │                              │ │
       │                              │ │
       │                              │ │
┌──────┴──────┐                ┌──────┴─┴────┐
│             │                │              │
│  本地缓存   │                │  云数据库    │
│             │                │              │
└─────────────┘                └──────────────┘
```

## 数据库设计

### 1. messages 集合
- **_id**: 自动生成的文档ID
- **id**: 客户端生成的消息ID
- **openid**: 用户标识
- **role**: 'user' 或 'ai'
- **content**: 消息内容
- **time**: 显示时间
- **timestamp**: 毫秒时间戳
- **sessionDate**: 会话日期，格式 'YYYY-MM-DD'
- **analyzed**: 是否已分析并生成摘要
- **tags**: 自动标记的主题标签
- **sentiment**: 情绪分析结果

### 2. summaries 集合
- **_id**: 自动生成的文档ID
- **openid**: 用户标识
- **type**: 'daily', 'weekly', 或 'monthly'
- **date**: 日期标识
- **content**: 总结内容
- **keyPoints**: 关键点列表
- **emotionAnalysis**: 情绪分析结果
- **tags**: 主题标签
- **timestamp**: 生成时间戳

## 数据安全策略

1. **数据加密**
   - 传输数据使用HTTPS协议
   - 敏感数据存储时进行加密

2. **访问控制**
   - 设置云函数访问权限，确保只有授权用户能访问自己的数据
   - 使用数据库权限规则限制访问范围

3. **数据备份**
   - 定期备份用户数据
   - 提供数据导出功能

4. **合规性**
   - 明确用户隐私政策
   - 获取必要的用户授权

## 性能优化策略

1. **减少网络请求**
   - 使用本地缓存存储最近对话
   - 合并和批量处理数据请求

2. **懒加载和分页**
   - 历史消息分页加载
   - 图片资源懒加载

3. **资源优化**
   - 压缩静态资源
   - 优化组件重渲染

4. **响应速度保障**
   - 预加载常用资源
   - 优化云函数执行效率
   - 添加适当的加载状态反馈 